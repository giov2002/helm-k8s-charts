name: ğŸ” CI - Mail Chart Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'mail/**'
      - '.github/workflows/ci-mail.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'mail/**'
  workflow_dispatch:

env:
  CHART_PATH: mail

jobs:
  validate-mail-chart:
    name: ğŸ“‹ Validation du Chart Mail
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.15.4'

      - name: ğŸ” Helm Lint
        run: |
          echo "ğŸ” === VALIDATION HELM LINT ==="
          helm lint ${{ env.CHART_PATH }} --strict
          echo "âœ… Helm lint passed!"

      - name: ğŸ¨ Test Template Rendering
        run: |
          echo "ğŸ¨ === TEST DE RENDU DES TEMPLATES ==="
          helm template test-mail ${{ env.CHART_PATH }} --dry-run --debug > /tmp/rendered-mail.yaml
          
          echo "ğŸ“„ Objets Kubernetes gÃ©nÃ©rÃ©s:"
          grep -c "^kind:" /tmp/rendered-mail.yaml || echo "0"
          
          echo ""
          echo "ğŸ“‹ Types d'objets:"
          grep "^kind:" /tmp/rendered-mail.yaml | sort | uniq -c
          echo "âœ… Template rendering OK!"

      - name: ğŸ”’ Security Audit - Hard-coded Passwords
        run: |
          echo "ğŸ”’ === AUDIT: MOTS DE PASSE EN DUR ==="
          if grep -rn -E "(password|pwd|pass).*:.*['\"][^'\"]*[a-zA-Z0-9]{3,}[^'\"]*['\"]" ${{ env.CHART_PATH }}/ --include="*.yaml" --include="*.yml" | grep -v "passwordSecretRef" | grep -v "{{ .*password" | grep -v "#.*password"; then
            echo "âŒ Ã‰CHEC: Mots de passe en dur dÃ©tectÃ©s!"
            exit 1
          else
            echo "âœ… Aucun mot de passe en dur dÃ©tectÃ©"
          fi

      - name: ğŸ”’ Security Audit - Privileged Containers
        run: |
          echo "ğŸ”’ === AUDIT: PRIVILÃˆGES Ã‰LEVÃ‰S ==="
          if grep -rn -E "(privileged|runAsRoot|allowPrivilegeEscalation).*true" ${{ env.CHART_PATH }}/ --include="*.yaml"; then
            echo "âŒ Ã‰CHEC: PrivilÃ¨ges Ã©levÃ©s dÃ©tectÃ©s!"
            exit 1
          else
            echo "âœ… Aucun privilÃ¨ge Ã©levÃ© dÃ©tectÃ©"
          fi

      - name: ğŸ”’ Security Audit - Latest Image Tags
        run: |
          echo "ğŸ”’ === AUDIT: TAGS D'IMAGES ==="
          if grep -rn -E "image:.*latest" ${{ env.CHART_PATH }}/ --include="*.yaml" | grep -v "{{"; then
            echo "âš ï¸ WARNING: Images avec tag 'latest' dÃ©tectÃ©es!"
            echo "Recommandation: Utilisez des tags spÃ©cifiques"
          else
            echo "âœ… Pas d'images avec tag 'latest'"
          fi

      - name: ğŸ“ YAML Lint
        run: |
          echo "ğŸ“ === LINT YAML ==="
          sudo apt-get update && sudo apt-get install -y yamllint
          
          cat <<EOF > .yamllint
          extends: default
          rules:
            line-length:
              max: 120
              level: warning
            indentation:
              spaces: 2
            truthy:
              allowed-values: ['true', 'false', 'yes', 'no']
          ignore: |
            */templates/_helpers.tpl
          EOF
          
          find ${{ env.CHART_PATH }} -name "*.yaml" -o -name "*.yml" | while read file; do
            echo "ğŸ” Checking: $file"
            yamllint -c .yamllint "$file" || echo "âš ï¸ Warnings dans $file"
          done
          echo "âœ… YAML lint terminÃ©"

      - name: âœ… CI Success Summary
        if: success()
        run: |
          echo ""
          echo "ğŸ‰ === CI RÃ‰USSI ==="
          echo "âœ… Helm lint: OK"
          echo "âœ… Template rendering: OK"
          echo "âœ… Security audit: OK"
          echo "âœ… YAML lint: OK"
          echo ""
          echo "ğŸš€ Le chart mail est prÃªt pour le dÃ©ploiement!"
          echo "Vous pouvez maintenant lancer le CD avec Ansible"

      - name: âŒ CI Failure Summary
        if: failure()
        run: |
          echo ""
          echo "ğŸ’¥ === CI Ã‰CHOUÃ‰ ==="
          echo "âŒ Des erreurs ont Ã©tÃ© dÃ©tectÃ©es"
          echo "VÃ©rifiez les logs ci-dessus pour plus de dÃ©tails"
          echo ""
          echo "ğŸ”§ Actions recommandÃ©es:"
          echo "  1. Corrigez les erreurs signalÃ©es"
          echo "  2. Testez localement avec: helm lint mail/"
          echo "  3. Poussez les corrections"
          exit 1