name: 🔍 CI - Mail Chart Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'mail/**'
      - '.github/workflows/ci-mail.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'mail/**'
  workflow_dispatch:

env:
  CHART_PATH: mail

jobs:
  validate-mail-chart:
    name: 📋 Validation du Chart Mail
    runs-on: self-hosted
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: ⚙️ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.15.4'

      - name: 🔍 Helm Lint (non-strict)
        run: |
          echo "🔍 === VALIDATION HELM LINT ==="
          helm lint ${{ env.CHART_PATH }}
          echo "✅ Helm lint passed!"

      - name: 🎨 Test Template Rendering
        run: |
          echo "🎨 === TEST DE RENDU DES TEMPLATES ==="
          helm template test-mail ${{ env.CHART_PATH }} > /tmp/rendered-mail.yaml
          
          echo "📄 Objets Kubernetes générés:"
          grep -c "^kind:" /tmp/rendered-mail.yaml || echo "0"
          
          echo ""
          echo "📋 Types d'objets:"
          grep "^kind:" /tmp/rendered-mail.yaml | sort | uniq -c
          echo "✅ Template rendering OK!"

      - name: 🔒 Security Audit - Passwords (Informational)
        run: |
          echo "🔒 === AUDIT: MOTS DE PASSE ==="
          echo "ℹ️ Vérification informative des credentials..."
          
          echo ""
          echo "ℹ️ Secrets Kubernetes détectés:"
          grep -l "kind: Secret" ${{ env.CHART_PATH }}/templates/*.yaml || echo "Aucun"
          
          echo ""
          echo "ℹ️ Variables d'environnement sensibles:"
          grep -n "PASSWORD\|SECRET\|TOKEN\|KEY" ${{ env.CHART_PATH }}/templates/*.yaml | head -10 || echo "Aucune"
          
          echo ""
          echo "✅ Audit informatif terminé (non-bloquant)"

      - name: 🔒 Security Audit - Capabilities
        run: |
          echo "🔒 === AUDIT: CAPABILITIES ==="
          
          if grep -A5 "capabilities:" ${{ env.CHART_PATH }}/templates/*.yaml 2>/dev/null; then
            echo ""
            echo "ℹ️ Capabilities détectées (nécessaires pour mailserver)"
          else
            echo "✅ Aucune capability particulière"
          fi

      - name: 🔒 Security Audit - Image Tags
        run: |
          echo "🔒 === AUDIT: TAGS D'IMAGES ==="
          
          if grep -n "image:" ${{ env.CHART_PATH }}/templates/*.yaml | grep -i "latest"; then
            echo "⚠️ WARNING: Tag 'latest' détecté"
            echo "ℹ️ Recommandation: Utilisez des versions fixes"
          else
            echo "✅ Tags d'images spécifiques utilisés"
          fi

      - name: 📏 YAML Lint (non-strict)
        run: |
          echo "📏 === LINT YAML ==="
          sudo apt-get update -qq && sudo apt-get install -y yamllint
          
          cat > .yamllint <<EOF
          extends: default
          rules:
            line-length: disable
            indentation:
              spaces: 2
              indent-sequences: whatever
            truthy: disable
            comments: disable
          EOF
          
          echo "🔍 Vérification basique des fichiers YAML..."
          find ${{ env.CHART_PATH }} -name "*.yaml" | while read file; do
            echo "  - $file"
            yamllint -c .yamllint "$file" || echo "    ⚠️ Warnings (non-bloquant)"
          done
          echo "✅ YAML lint terminé"

      - name: 📊 Chart Info
        run: |
          echo "📊 === INFORMATIONS DU CHART ==="
          echo ""
          echo "📁 Fichiers du chart:"
          find ${{ env.CHART_PATH }} -type f -name "*.yaml" -o -name "*.yml" | sort
          
          echo ""
          echo "📋 Chart.yaml:"
          cat ${{ env.CHART_PATH }}/Chart.yaml
          
          echo ""
          echo "🎯 Templates disponibles:"
          ls -1 ${{ env.CHART_PATH }}/templates/

      - name: ✅ CI Success Summary
        if: success()
        run: |
          echo ""
          echo "🎉 =========================================="
          echo "🎉      CI VALIDATION RÉUSSIE"
          echo "🎉 =========================================="
          echo ""
          echo "✅ Helm lint: OK"
          echo "✅ Template rendering: OK"
          echo "✅ Security checks: OK (informatifs)"
          echo "✅ YAML lint: OK"
          echo ""
          echo "🚀 Le chart mail est validé!"
          echo "📦 Prêt pour le déploiement avec Ansible"
          echo ""

      - name: ❌ CI Failure
        if: failure()
        run: |
          echo ""
          echo "💥 CI a rencontré des erreurs"
          echo "Consultez les logs ci-dessus"
          exit 1