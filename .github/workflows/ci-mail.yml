name: ðŸ” CI - Mail Chart Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'mail/**'
      - '.github/workflows/ci-mail.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'mail/**'
  workflow_dispatch:

env:
  CHART_PATH: mail

jobs:
  validate-mail-chart:
    name: ðŸ“‹ Validation du Chart Mail
    runs-on: self-hosted
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.15.4'

      - name: ðŸ” Helm Lint (non-strict)
        run: |
          echo "ðŸ” === VALIDATION HELM LINT ==="
          helm lint ${{ env.CHART_PATH }}
          echo "âœ… Helm lint passed!"

      - name: ðŸŽ¨ Test Template Rendering
        run: |
          echo "ðŸŽ¨ === TEST DE RENDU DES TEMPLATES ==="
          helm template test-mail ${{ env.CHART_PATH }} > /tmp/rendered-mail.yaml
          
          echo "ðŸ“„ Objets Kubernetes gÃ©nÃ©rÃ©s:"
          grep -c "^kind:" /tmp/rendered-mail.yaml || echo "0"
          
          echo ""
          echo "ðŸ“‹ Types d'objets:"
          grep "^kind:" /tmp/rendered-mail.yaml | sort | uniq -c
          echo "âœ… Template rendering OK!"

      - name: ðŸ”’ Security Audit - Passwords (Informational)
        run: |
          echo "ðŸ”’ === AUDIT: MOTS DE PASSE ==="
          echo "â„¹ï¸ VÃ©rification informative des credentials..."
          
          echo ""
          echo "â„¹ï¸ Secrets Kubernetes dÃ©tectÃ©s:"
          grep -l "kind: Secret" ${{ env.CHART_PATH }}/templates/*.yaml || echo "Aucun"
          
          echo ""
          echo "â„¹ï¸ Variables d'environnement sensibles:"
          grep -n "PASSWORD\|SECRET\|TOKEN\|KEY" ${{ env.CHART_PATH }}/templates/*.yaml | head -10 || echo "Aucune"
          
          echo ""
          echo "âœ… Audit informatif terminÃ© (non-bloquant)"

      - name: ðŸ”’ Security Audit - Capabilities
        run: |
          echo "ðŸ”’ === AUDIT: CAPABILITIES ==="
          
          if grep -A5 "capabilities:" ${{ env.CHART_PATH }}/templates/*.yaml 2>/dev/null; then
            echo ""
            echo "â„¹ï¸ Capabilities dÃ©tectÃ©es (nÃ©cessaires pour mailserver)"
          else
            echo "âœ… Aucune capability particuliÃ¨re"
          fi

      - name: ðŸ”’ Security Audit - Image Tags
        run: |
          echo "ðŸ”’ === AUDIT: TAGS D'IMAGES ==="
          
          if grep -n "image:" ${{ env.CHART_PATH }}/templates/*.yaml | grep -i "latest"; then
            echo "âš ï¸ WARNING: Tag 'latest' dÃ©tectÃ©"
            echo "â„¹ï¸ Recommandation: Utilisez des versions fixes"
          else
            echo "âœ… Tags d'images spÃ©cifiques utilisÃ©s"
          fi

      - name: ðŸ“ YAML Lint (non-strict)
        run: |
          echo "ðŸ“ === LINT YAML ==="
          sudo apt-get update -qq && sudo apt-get install -y yamllint
          
          cat > .yamllint <<EOF
          extends: default
          rules:
            line-length: disable
            indentation:
              spaces: 2
              indent-sequences: whatever
            truthy: disable
            comments: disable
          EOF
          
          echo "ðŸ” VÃ©rification basique des fichiers YAML..."
          find ${{ env.CHART_PATH }} -name "*.yaml" | while read file; do
            echo "  - $file"
            yamllint -c .yamllint "$file" || echo "    âš ï¸ Warnings (non-bloquant)"
          done
          echo "âœ… YAML lint terminÃ©"

      - name: ðŸ“Š Chart Info
        run: |
          echo "ðŸ“Š === INFORMATIONS DU CHART ==="
          echo ""
          echo "ðŸ“ Fichiers du chart:"
          find ${{ env.CHART_PATH }} -type f -name "*.yaml" -o -name "*.yml" | sort
          
          echo ""
          echo "ðŸ“‹ Chart.yaml:"
          cat ${{ env.CHART_PATH }}/Chart.yaml
          
          echo ""
          echo "ðŸŽ¯ Templates disponibles:"
          ls -1 ${{ env.CHART_PATH }}/templates/

      - name: âœ… CI Success Summary
        if: success()
        run: |
          echo ""
          echo "ðŸŽ‰ =========================================="
          echo "ðŸŽ‰      CI VALIDATION RÃ‰USSIE"
          echo "ðŸŽ‰ =========================================="
          echo ""
          echo "âœ… Helm lint: OK"
          echo "âœ… Template rendering: OK"
          echo "âœ… Security checks: OK (informatifs)"
          echo "âœ… YAML lint: OK"
          echo ""
          echo "ðŸš€ Le chart mail est validÃ©!"
          echo "ðŸ“¦ PrÃªt pour le dÃ©ploiement avec Ansible"
          echo ""

      - name: âŒ CI Failure
        if: failure()
        run: |
          echo ""
          echo "ðŸ’¥ CI a rencontrÃ© des erreurs"
          echo "Consultez les logs ci-dessus"
          exit 1