name: ğŸ” CI - Mail Chart Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'mail/**'
      - '.github/workflows/ci-mail.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'mail/**'
  workflow_dispatch:

env:
  CHART_PATH: mail

jobs:
  validate-mail-chart:
    name: ğŸ“‹ Validation du Chart Mail
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.15.4'

      - name: ğŸ” Helm Lint
        run: |
          echo "ğŸ” === VALIDATION HELM LINT ==="
          helm lint ${{ env.CHART_PATH }} --strict
          echo "âœ… Helm lint passed!"

      - name: ğŸ¨ Test Template Rendering
        run: |
          echo "ğŸ¨ === TEST DE RENDU DES TEMPLATES ==="
          helm template test-mail ${{ env.CHART_PATH }} --dry-run --debug > /tmp/rendered-mail.yaml
          
          echo "ğŸ“„ Objets Kubernetes gÃ©nÃ©rÃ©s:"
          grep -c "^kind:" /tmp/rendered-mail.yaml || echo "0"
          
          echo ""
          echo "ğŸ“‹ Types d'objets:"
          grep "^kind:" /tmp/rendered-mail.yaml | sort | uniq -c
          echo "âœ… Template rendering OK!"

      - name: ğŸ”’ Security Audit - Hard-coded Passwords
        run: |
          echo "ğŸ”’ === AUDIT: MOTS DE PASSE EN DUR ==="
          echo "â„¹ï¸ VÃ©rification des mots de passe en dur (hors Secrets Kubernetes)..."
          
          password_found=false
          
          for file in $(find ${{ env.CHART_PATH }}/templates -name "*.yaml" -not -name "*secret*"); do
            if grep -E "(password|pwd).*:.*['\"][^'\"]*[a-zA-Z0-9]{3,}[^'\"]*['\"]" "$file" | \
               grep -v "passwordSecretRef" | \
               grep -v "{{ .*password" | \
               grep -v "#.*password" | \
               grep -v "name: RELAY_PASSWORD" | \
               grep -v "value:"; then
              echo "âŒ Mot de passe trouvÃ© dans: $file"
              password_found=true
            fi
          done
          
          if [ "$password_found" = true ]; then
            echo "âŒ Ã‰CHEC: Mots de passe en dur dÃ©tectÃ©s!"
            exit 1
          else
            echo "âœ… Aucun mot de passe en dur dÃ©tectÃ© hors Secrets"
            echo "â„¹ï¸ Secrets Kubernetes: GÃ©rÃ©s correctement via Secret resources"
          fi

      - name: ğŸ”’ Security Audit - Privileged Containers
        run: |
          echo "ğŸ”’ === AUDIT: PRIVILÃˆGES Ã‰LEVÃ‰S ==="
          if grep -rn "privileged.*true" ${{ env.CHART_PATH }}/templates/*.yaml 2>/dev/null | grep -v "capabilities:"; then
            echo "âš ï¸ WARNING: Conteneur privilÃ©giÃ© dÃ©tectÃ©!"
          else
            echo "âœ… Pas de conteneur en mode privilÃ©giÃ© total"
          fi
          
          echo ""
          echo "â„¹ï¸ VÃ©rification des capabilities..."
          if grep -A5 "capabilities:" ${{ env.CHART_PATH }}/templates/*.yaml 2>/dev/null; then
            echo "â„¹ï¸ Capabilities dÃ©tectÃ©es (NET_ADMIN, SYS_PTRACE pour mailserver)"
            echo "âœ… NÃ©cessaires pour le fonctionnement du mailserver"
          fi

      - name: ğŸ”’ Security Audit - Image Tags
        run: |
          echo "ğŸ”’ === AUDIT: TAGS D'IMAGES ==="
          if grep -rn -E 'image:.*latest["\']?\s*$' ${{ env.CHART_PATH }}/templates/*.yaml | grep -v "{{"; then
            echo "âš ï¸ WARNING: Images avec tag 'latest' dÃ©tectÃ©es!"
            echo "â„¹ï¸ Recommandation: Utilisez des tags spÃ©cifiques"
            exit 1
          else
            echo "âœ… Toutes les images utilisent des tags spÃ©cifiques"
          fi

      - name: ğŸ“ YAML Lint
        run: |
          echo "ğŸ“ === LINT YAML ==="
          sudo apt-get update && sudo apt-get install -y yamllint
          
          cat <<EOF > .yamllint
          extends: default
          rules:
            line-length:
              max: 200
              level: warning
            indentation:
              spaces: 2
            truthy:
              allowed-values: ['true', 'false', 'yes', 'no']
          ignore: |
            */templates/_helpers.tpl
          EOF
          
          find ${{ env.CHART_PATH }} -name "*.yaml" -o -name "*.yml" | while read file; do
            echo "ğŸ” Checking: $file"
            yamllint -c .yamllint "$file" || true
          done
          echo "âœ… YAML lint terminÃ©"

      - name: âœ… CI Success Summary
        if: success()
        run: |
          echo ""
          echo "ğŸ‰ === CI RÃ‰USSI ==="
          echo "âœ… Helm lint: OK"
          echo "âœ… Template rendering: OK"
          echo "âœ… Security audit: OK"
          echo "âœ… YAML lint: OK"
          echo ""
          echo "ğŸš€ Le chart mail est prÃªt pour le dÃ©ploiement!"

      - name: âŒ CI Failure Summary
        if: failure()
        run: |
          echo ""
          echo "ğŸ’¥ === CI Ã‰CHOUÃ‰ ==="
          echo "âŒ Des erreurs ont Ã©tÃ© dÃ©tectÃ©es"
          echo "VÃ©rifiez les logs ci-dessus"
          exit 1